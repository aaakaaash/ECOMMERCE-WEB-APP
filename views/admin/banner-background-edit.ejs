<%- include("../../views/partials/admin/header") %>


<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
</head>

<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <br>
            <h2 class="mb-4">Edit Image</h2>

            <br><br><br>

            <form action="/admin/banner-background/edit-image/<%= image._id %>" method="POST" enctype="multipart/form-data" id="editImageForm">
                <div class="mb-3">
                    <label for="image" class="form-label">Choose Image</label>
                    <input type="file" class="form-control" id="imageInput" name="image" accept="image/*" required>
                </div>
                <div class="mb-3">
                    <img id="imagePreview" src="/uploads/images-UI/<%= image.image %>" alt="Image Preview" class="img-fluid" style="max-width: 300px; display: none;">
                </div>
                <div class="mb-3">
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
                <button type="button" class="btn btn-danger" id="removeImage">Remove Image</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>

<script>
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const removeImageBtn = document.getElementById('removeImage');
    const submitBtn = document.querySelector('button[type="submit"]');
    let cropper;

    
    removeImageBtn.style.display = 'none';
    submitBtn.disabled = true;

    imageInput.addEventListener('change', function (e) {
        const files = e.target.files;
        if (files.length > 0) {
            const file = files[0];
            const reader = new FileReader();
            reader.onload = function (event) {
                imagePreview.src = event.target.result;
                imagePreview.style.display = 'block';
                removeImageBtn.style.display = 'inline-block';
                submitBtn.disabled = false;

        
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(imagePreview, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    ready: function () {
                        canvas.width = this.cropper.getData().width;
                        canvas.height = this.cropper.getData().height;
                    }
                });
            };
            reader.readAsDataURL(file);
        }
    });

    removeImageBtn.addEventListener('click', function () {
        imageInput.value = ''; 
        imagePreview.src = ''; 
        imagePreview.style.display = 'none'; 
        removeImageBtn.style.display = 'none'; 
        submitBtn.disabled = true; 
        if (cropper) {
            cropper.destroy(); 
        }
    });

    $('#editImageForm').on('submit', function (e) {
    e.preventDefault(); 
    if (cropper) {
        
        cropper.getCroppedCanvas().toBlob(function (blob) {
            const formData = new FormData();
            formData.append('image', blob, 'cropped.jpg'); 
            $.ajax({
                url: $(e.target).attr('action'),
                type: 'PUT', 
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Image updated successfully!',
                    }).then(() => {
                        window.location.href = '/admin/banner-background'; 
                    });
                },
                error: function (xhr) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: xhr.responseText,
                    });
                }
            });
        }, 'image/jpeg');
    }
});

</script>

<%- include("../../views/partials/admin/footer") %>
